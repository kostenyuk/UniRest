Перем мНаборыШаблон;

Перем мКэшОбработки;

// Процедура перепроведения документов
//
// Параметры: 
//  ДатаНач - дата, начиная с которой перепроводятся документы
//  Организация - организация, по которой перепроводятся документы
//  СдвигатьГраницуАктуальности - флаг сдвига назад даты актульности по разделам учета при ошибке проведения документа

Процедура ПерепроведениеДокументов(ДатаНач, ДатаКон = '00010101', Организация = Неопределено, СдвигатьГраницуАктуальности = Ложь) Экспорт
	
	Перем ФормаПрогрессора;
	
	мНаборыШаблон = Новый Структура;
	
	#Если Клиент Тогда
		ФормаПрогрессора = ПолучитьОбщуюФорму("ХодВыполненияОбработкиДанных");
		ФормаПрогрессора.НаименованиеОбработкиДанных = "Групповое перепроведение документов";
	#КонецЕсли
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Организация", Организация);
	
	Для Каждого ДокументМетаданные ИЗ Метаданные.Документы Цикл
		
		Запрос.Текст = Запрос.Текст + ?(Запрос.Текст = "", "", "
		|ОБЪЕДИНИТЬ ВСЕ
		|") + "ВЫБРАТЬ """ + ДокументМетаданные.Имя + """ КАК ИмяДокумента, Представление КАК Представление, Ссылка КАК Ссылка, Дата КАК Дата ИЗ Документ." + ДокументМетаданные.Имя + "
		|ГДЕ Проведен И Дата >= &ДатаНач";
		
		Если ДатаКон <> Дата('00010101') Тогда
			Запрос.Текст = Запрос.Текст + " И Дата <= &ДатаКон";
		КонецЕсли;
		
		Если Организация <> Неопределено И ДокументМетаданные.Реквизиты.Найти("Организация") <> Неопределено Тогда
			Если ТипЗнч(Организация) = Тип("Массив") Тогда
				Запрос.Текст = Запрос.Текст + " И Организация В (&Организация)";
			Иначе
				Запрос.Текст = Запрос.Текст + " И Организация = &Организация";
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
	Запрос.Текст = Запрос.Текст + "
	|УПОРЯДОЧИТЬ ПО Дата, Ссылка";
	
	Запрос.УстановитьПараметр("ДатаНач", ДатаНач);
	Запрос.УстановитьПараметр("ДатаКон", КонецДня(ДатаКон));
	
	ТаблицаДокументов = Запрос.Выполнить().Выгрузить();
	ТаблицаДокументов.Колонки.Добавить("БылаОшибка", Новый ОписаниеТипов("Булево"));
	ВсегоДокументов = ТаблицаДокументов.Количество();
	
	
	Если УдалятьДвиженияДокументовПередПроведением Тогда
		Если ФормаПрогрессора <> Неопределено Тогда
			ФормаПрогрессора.Значение = 0;
			ФормаПрогрессора.МаксимальноеЗначение = ВсегоДокументов;		
			ФормаПрогрессора.КомментарийОбработкиДанных  = "Удаление движений проведенных документов";		
			ФормаПрогрессора.Открыть();
		КонецЕсли;	
		
		Для Каждого СтрокаДокумента ИЗ ТаблицаДокументов Цикл
			
			Если ФормаПрогрессора <> Неопределено Тогда
				ФормаПрогрессора.КомментарийЗначения = СтрокаДокумента.Представление;
				ФормаПрогрессора.Значение = ФормаПрогрессора.Значение + 1;
			КонецЕсли;
			
			Регистратор = СтрокаДокумента.Ссылка;
			КоллекцияДвижений = Метаданные.Документы[СтрокаДокумента.ИмяДокумента].Движения;
			НачатьТранзакцию();
			Для Каждого НаборМетаданные ИЗ КоллекцияДвижений Цикл
				Набор = ПолучитьНаборЗаписей(НаборМетаданные);
				Набор.Отбор.Регистратор.Установить(Регистратор);
				Набор.Записать();
				Запрос.УстановитьПараметр(СтрокаДокумента.ИмяДокумента + "Ссылка", Регистратор);
				Запрос.УстановитьПараметр(СтрокаДокумента.ИмяДокумента + "Дата", СтрокаДокумента.Дата);
			КонецЦикла;
			ЗафиксироватьТранзакцию();
			
		КонецЦикла;	
	КонецЕсли;
	
	Если ФормаПрогрессора <> Неопределено Тогда
		ФормаПрогрессора.Значение = 0;
		ФормаПрогрессора.МаксимальноеЗначение = ВсегоДокументов;
		ФормаПрогрессора.КомментарийОбработкиДанных  = "Проведение документов";		
		ФормаПрогрессора.Открыть();
	КонецЕсли;	
	
	
	
	ИндексСтрокиНачалаДаты = Неопределено;
	ТекущаяДатаПроведения = Неопределено;
	
	Для индекс = 0 ПО ВсегоДокументов - 1 Цикл
		СтрокаДокумента = ТаблицаДокументов[индекс];
		Если ФормаПрогрессора <> Неопределено Тогда
			ФормаПрогрессора.КомментарийЗначения = СтрокаДокумента.Представление;
			ФормаПрогрессора.Значение = ФормаПрогрессора.Значение + 1;
		КонецЕсли;
		
		ДокументОбъект = СтрокаДокумента.Ссылка.ПолучитьОбъект();
		Если ТекущаяДатаПроведения <> ДокументОбъект.Дата Тогда
			ИндексСтрокиНачалаДаты = индекс;
			ТекущаяДатаПроведения = ДокументОбъект.Дата;
		КонецЕсли;
		
		Попытка
			ДокументОбъект.Записать(РежимЗаписиДокумента.Проведение, РежимПроведенияДокумента.Неоперативный);
		Исключение
			Если СдвигатьГраницуАктуальности Тогда
				
				Если СтрокаДокумента.БылаОшибка Тогда
					// для документа уже была ошибка проведения, продолжение не возможно
					ОбщегоНазначения.СообщитьОбОшибке(Локализация.СтрокаШаблон("Документ ¤1¤ не проведен!"
"По причине: ¤2¤", Строка(ДокументОбъект), ОписаниеОшибки()), , "Ошибка проведения!");
					Если ОстанавливатьсяПоОшибке Тогда
						Прервать;
					КонецЕсли;
				КонецЕсли;
				
				СдвигГраницыАктуалностиПоРазделам(СтрокаДокумента.ИмяДокумента, ДокументОбъект);
				СтрокаДокумента.БылаОшибка = Истина;
				индекс = ИндексСтрокиНачалаДаты;
				
			Иначе
				
				ОбщегоНазначения.СообщитьОбОшибке(Локализация.СтрокаШаблон("Документ ¤1¤ не проведен!"
"По причине: ¤2¤", Строка(ДокументОбъект), ОписаниеОшибки()), , "Ошибка проведения!");
				Если ОстанавливатьсяПоОшибке Тогда
					Прервать;
				КонецЕсли;				
				
			КонецЕсли;
		КонецПопытки;
		
	КонецЦикла;
	
	Если ФормаПрогрессора <> Неопределено Тогда
		ФормаПрогрессора.Закрыть();
	КонецЕсли;
	
КонецПроцедуры

Процедура СдвигГраницыАктуалностиПоРазделам(ИмяДокумента, ДокументОбъект)
	
	МетаданныеОбъекта = мКэшОбработки.МетаданныеОбъектов[ИмяДокумента];
	Если МетаданныеОбъекта = Неопределено Тогда
		МетаданныеОбъекта = ДокументОбъект.Метаданные();
		мКэшОбработки.МетаданныеОбъектов[ИмяДокумента] = МетаданныеОбъекта;
	КонецЕсли;
	
	Если МетаданныеОбъекта.Реквизиты.Найти("Организация") = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ДатыПоРазделам = мКэшОбработки.АктуальностьРазделовПоОрганизации[ДокументОбъект.Организация];
	Если ДатыПоРазделам = Неопределено Тогда
		ДатыПоРазделам = РегистрыСведений.ДатаАктуальностиУчета.Получить(Новый Структура("Организация", ДокументОбъект.Организация));
		мКэшОбработки.АктуальностьРазделовПоОрганизации[ДокументОбъект.Организация] = ДатыПоРазделам;		
	КонецЕсли;
	
	НужнаЗапись = Ложь;
	Для Каждого КлючИЗначение ИЗ ДатыПоРазделам Цикл
		Если КлючИЗначение.Значение > НачалоДня(НачалоДня(ДокументОбъект.Дата) - 1) Тогда
			ДатыПоРазделам[КлючИЗначение.Ключ] = НачалоДня(НачалоДня(ДокументОбъект.Дата) - 1);
			НужнаЗапись = Истина;
		КонецЕсли;		
	КонецЦикла;	
	
	Если НужнаЗапись Тогда
		Запись = РегистрыСведений.ДатаАктуальностиУчета.СоздатьМенеджерЗаписи();
		Запись.Организация = ДокументОбъект.Организация;
		Для Каждого КлючИЗначение ИЗ ДатыПоРазделам Цикл
			Запись[КлючИЗначение.Ключ] = КлючИЗначение.Значение;
		КонецЦикла;
		Запись.Записать();
	КонецЕсли;
			
КонецПроцедуры

Функция ПолучитьНаборЗаписей(НаборМетаданные)
	
	Если мНаборыШаблон.Свойство(НаборМетаданные.Имя) Тогда
		Возврат мНаборыШаблон[НаборМетаданные.Имя];
		
	Иначе
		Если Метаданные.РегистрыСведений.Содержит(НаборМетаданные) Тогда
			Набор = РегистрыСведений[НаборМетаданные.Имя].СоздатьНаборЗаписей();
			
		ИначеЕсли Метаданные.РегистрыНакопления.Содержит(НаборМетаданные) Тогда
			Набор = РегистрыНакопления[НаборМетаданные.Имя].СоздатьНаборЗаписей();
			
		ИначеЕсли Метаданные.РегистрыБухгалтерии.Содержит(НаборМетаданные) Тогда
			Набор = РегистрыБухгалтерии[НаборМетаданные.Имя].СоздатьНаборЗаписей();
			
		ИначеЕсли Метаданные.РегистрыРасчета.Содержит(НаборМетаданные) Тогда
			Набор = РегистрыРасчета[НаборМетаданные.Имя].СоздатьНаборЗаписей();
			
		КонецЕсли;	
		
		мНаборыШаблон.Вставить(НаборМетаданные.Имя, Набор);
		Возврат Набор;
		
	КонецЕсли;
	
КонецФункции

мКэшОбработки = Новый Структура;
мКэшОбработки.Вставить("МетаданныеОбъектов", Новый Соответствие);
мКэшОбработки.Вставить("АктуальностьРазделовПоОрганизации", Новый Соответствие);
